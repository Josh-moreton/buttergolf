name: SEO Checks

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'apps/web/src/app/**'
      - 'apps/web/src/components/**'
      - 'apps/web/next-sitemap.config.js'
      - 'apps/web/package.json'

jobs:
  seo-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        env:
          SITE_URL: 'https://buttergolf.com'
        run: |
          cd apps/web
          pnpm build

      - name: Check sitemap exists
        run: |
          if [ ! -f ./apps/web/public/sitemap.xml ]; then
            echo "❌ Missing sitemap.xml"
            exit 1
          fi
          echo "✅ sitemap.xml exists"

      - name: Check robots.txt exists
        run: |
          if [ ! -f ./apps/web/public/robots.txt ]; then
            echo "❌ Missing robots.txt"
            exit 1
          fi
          echo "✅ robots.txt exists"

      - name: Validate sitemap format
        run: |
          if ! grep -q "<?xml" ./apps/web/public/sitemap.xml; then
            echo "❌ sitemap.xml is not valid XML"
            exit 1
          fi
          if ! grep -q "<urlset" ./apps/web/public/sitemap.xml; then
            echo "❌ sitemap.xml missing urlset tag"
            exit 1
          fi
          echo "✅ sitemap.xml is valid XML"

      - name: Check robots.txt references sitemap
        run: |
          if ! grep -q "Sitemap:" ./apps/web/public/robots.txt; then
            echo "❌ robots.txt does not reference sitemap"
            exit 1
          fi
          echo "✅ robots.txt references sitemap"

      - name: Check .well-known files exist
        run: |
          if [ ! -f ./apps/web/public/.well-known/apple-app-site-association ]; then
            echo "⚠️  Warning: Missing apple-app-site-association"
          else
            echo "✅ apple-app-site-association exists"
          fi
          
          if [ ! -f ./apps/web/public/.well-known/assetlinks.json ]; then
            echo "⚠️  Warning: Missing assetlinks.json"
          else
            echo "✅ assetlinks.json exists"
          fi

      - name: Check for SeoJsonLd usage
        run: |
          if ! grep -r "SeoJsonLd" ./apps/web/src/app/page.tsx; then
            echo "⚠️  Warning: Home page may be missing JSON-LD structured data"
          else
            echo "✅ Home page includes SeoJsonLd component"
          fi

      - name: Summary
        run: |
          echo "================================================"
          echo "SEO Validation Complete"
          echo "================================================"
          echo ""
          echo "✅ All critical checks passed!"
          echo ""
          echo "Next steps for production:"
          echo "1. Test sitemap in Google Search Console"
          echo "2. Validate structured data with Google Rich Results Test"
          echo "3. Update Team ID and package names in .well-known files"
          echo "4. Test deep linking on physical devices"
