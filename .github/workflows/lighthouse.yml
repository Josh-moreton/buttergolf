name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/app/**'
      - '.github/workflows/lighthouse.yml'
      - 'lighthouserc.js'
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/app/**'
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm --filter @buttergolf/db prisma generate

      - name: Build web app
        run: pnpm --filter web build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './lighthouserc.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment PR with Lighthouse results
        if: "github.event_name == 'pull_request'"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const lhciDir = '.lighthouseci';
            if (!fs.existsSync(lhciDir)) return;
            
            const files = fs.readdirSync(lhciDir).filter(f => f.startsWith('manifest') && f.endsWith('.json'));
            if (files.length === 0) return;
            
            const manifest = JSON.parse(fs.readFileSync(path.join(lhciDir, files[0])));
            const lhrFile = manifest[0]?.jsonPath;
            if (!lhrFile) return;
            
            const results = JSON.parse(fs.readFileSync(lhrFile));
            
            const scores = {
              performance: Math.round(results.categories.performance.score * 100),
              accessibility: Math.round(results.categories.accessibility.score * 100),
              bestPractices: Math.round(results.categories['best-practices'].score * 100),
              seo: Math.round(results.categories.seo.score * 100)
            };
            
            const getEmoji = (score) => score >= 90 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ ' : 'ðŸ”´';
            
            const body = `## âš¡ Lighthouse Report

| Category | Score |
|----------|-------|
| ðŸŸ¢ Performance | ${scores.performance} |
| ðŸŸ¢ Accessibility | ${scores.accessibility} |
| ðŸŸ¢ Best Practices | ${scores.bestPractices} |
| ðŸŸ¢ SEO | ${scores.seo} |

_Commit ${context.sha.substring(0, 7)}_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
      - continue-on-error: true
