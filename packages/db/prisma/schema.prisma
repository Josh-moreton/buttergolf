generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String         @id @default(cuid())
  clerkId                    String         @unique
  email                      String         @unique
  firstName                  String
  lastName                   String
  imageUrl                   String?
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  stripeAccountStatus        String?
  stripeConnectId            String?        @unique
  stripeOnboardingComplete   Boolean        @default(false)
  averageRating              Float?         @default(0)
  ratingCount                Int            @default(0)
  deletedAt                  DateTime?
  isDeleted                  Boolean        @default(false)
  stripeAccountType          String?        @default("express")
  stripeRequirementsDeadline DateTime?
  stripeRequirementsDue      Json?
  addresses                  Address[]
  favourites                 Favourite[]
  messages                   Message[]
  pushTokens                 String[]       @default([])
  buyerOffers                Offer[]        @relation("BuyerOffers")
  sellerOffers               Offer[]        @relation("SellerOffers")
  ordersPurchased            Order[]        @relation("BuyerOrders")
  ordersSold                 Order[]        @relation("SellerOrders")
  products                   Product[]
  ratingsGiven               SellerRating[] @relation("RatingsGiven")
  ratingsReceived            SellerRating[] @relation("SellerRatings")
  promotions                 ProductPromotion[]

  @@index([isDeleted])
  @@map("users")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  imageUrl    String?
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model Brand {
  id         String      @id @default(cuid())
  name       String      @unique
  slug       String      @unique
  logoUrl    String?
  sortOrder  Int         @default(0)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  clubModels ClubModel[]
  products   Product[]

  @@map("brands")
}

model ClubModel {
  id         String   @id @default(cuid())
  brandId    String
  name       String
  kind       ClubKind
  isVerified Boolean  @default(false)
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, name, kind])
  @@index([brandId])
  @@index([isVerified])
  @@index([usageCount])
  @@map("club_models")
}

model Product {
  id          String           @id @default(cuid())
  title       String
  description String
  price       Float
  condition   ProductCondition
  model       String?
  userId      String
  categoryId  String
  isSold      Boolean          @default(false)
  isDraft     Boolean          @default(false)
  views       Int              @default(0)
  length      Float?
  width       Float?
  height      Float?
  weight      Float?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  brandId     String?
  flex                 String?
  loft                 String?
  requestId            String?  // Idempotency key to prevent duplicate submissions
  woodsSubcategory     String?  // Driver, Fairway Wood, Hybrid
  headCoverIncluded    Boolean? @default(false)
  gripCondition        Int?     @default(7)
  headCondition        Int?     @default(7)
  shaftCondition       Int?     @default(7)
  favourites  Favourite[]
  offers      Offer[]
  orders      Order[]
  images      ProductImage[]
  promotions  ProductPromotion[]
  brand       Brand?           @relation(fields: [brandId], references: [id])
  category    Category         @relation(fields: [categoryId], references: [id])
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([userId])
  @@index([brandId])
  @@index([isSold])
  @@index([views])
  @@index([requestId])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  url       String
  productId String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model Favourite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favourites")
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  name       String
  street1    String
  street2    String?
  city       String
  state      String?
  zip        String
  country    String   @default("GB")
  phone      String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  firstName  String?
  lastName   String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersFrom Order[]  @relation("FromAddress")
  ordersTo   Order[]  @relation("ToAddress")

  @@index([userId])
  @@map("addresses")
}

model Order {
  id                   String         @id @default(cuid())
  stripePaymentId      String?        @unique
  stripeCheckoutId     String?
  amountTotal          Float
  shippingCost         Float
  sellerId             String
  buyerId              String
  productId            String
  fromAddressId        String
  toAddressId          String
  easypostShipmentId   String?
  shipEngineShipmentId String?
  shipEngineRateId     String?
  labelUrl             String?
  labelFormat          String?
  trackingCode         String?
  trackingUrl          String?
  carrier              String?
  service              String?
  shipmentStatus       ShipmentStatus @default(PENDING)
  estimatedDelivery    DateTime?
  actualDelivery       DateTime?
  status               OrderStatus    @default(PAYMENT_CONFIRMED)
  labelGeneratedAt     DateTime?
  shippedAt            DateTime?
  deliveredAt          DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  stripePayoutDate     DateTime?
  stripePayoutStatus   String?
  stripePlatformFee    Float?
  stripeSellerPayout   Float?
  stripeTransferId     String?
  // Vinted-style payment hold (escrow) fields
  paymentHoldStatus    PaymentHoldStatus @default(HELD)
  paymentHeldAt        DateTime?
  paymentReleasedAt    DateTime?
  autoReleaseAt        DateTime?
  buyerConfirmedAt     DateTime?
  // Buyer protection fee tracking
  buyerProtectionFee   Float?
  stripeChargeId       String?
  buyer                User           @relation("BuyerOrders", fields: [buyerId], references: [id])
  fromAddress          Address        @relation("FromAddress", fields: [fromAddressId], references: [id])
  product              Product        @relation(fields: [productId], references: [id])
  seller               User           @relation("SellerOrders", fields: [sellerId], references: [id])
  toAddress            Address        @relation("ToAddress", fields: [toAddressId], references: [id])
  sellerRating         SellerRating?
  messages             Message[]

  @@index([sellerId])
  @@index([buyerId])
  @@index([productId])
  @@index([shipmentStatus])
  @@index([status])
  @@index([paymentHoldStatus])
  @@index([autoReleaseAt])
  @@map("orders")
}

model Message {
  id        String   @id @default(cuid())
  orderId   String
  senderId  String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model SellerRating {
  id        String   @id @default(cuid())
  sellerId  String
  buyerId   String
  orderId   String   @unique
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  buyer     User     @relation("RatingsGiven", fields: [buyerId], references: [id], onDelete: Cascade)
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seller    User     @relation("SellerRatings", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([buyerId])
  @@index([orderId])
  @@map("seller_ratings")
}

model Offer {
  id            String         @id @default(cuid())
  amount        Float
  status        OfferStatus    @default(PENDING)
  message       String?
  productId     String
  buyerId       String
  sellerId      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  expiresAt     DateTime?
  counterOffers CounterOffer[]
  buyer         User           @relation("BuyerOffers", fields: [buyerId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  seller        User           @relation("SellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([expiresAt])
  @@map("offers")
}

model CounterOffer {
  id         String   @id @default(cuid())
  amount     Float
  message    String?
  fromSeller Boolean
  offerId    String
  createdAt  DateTime @default(now())
  offer      Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("counter_offers")
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("coming-soon")
  createdAt DateTime @default(now())

  @@map("waitlist")
}

model ProductPromotion {
  id              String          @id @default(cuid())
  productId       String
  userId          String
  type            PromotionType
  status          PromotionStatus @default(PENDING)
  stripePaymentId String?
  amountPaid      Float
  startsAt        DateTime?
  expiresAt       DateTime?
  purchasedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("product_promotions")
}

enum ClubKind {
  DRIVER
  FAIRWAY_WOOD
  HYBRID
  IRON_SET
  WEDGE
  PUTTER
  BALL
  BAG
  APPAREL
  ACCESSORY
  OTHER
}

enum ProductCondition {
  NEW
  LIKE_NEW
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum ShipmentStatus {
  PENDING
  PRE_TRANSIT
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  FAILED
  CANCELLED
}

enum OrderStatus {
  PAYMENT_CONFIRMED
  LABEL_GENERATED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  EXPIRED
}

enum PaymentHoldStatus {
  HELD
  RELEASED
  DISPUTED
  REFUNDED
}

enum PromotionType {
  BUMP
  PRO_SHOP_FEATURE
}

enum PromotionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}
